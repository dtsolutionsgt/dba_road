/****** #CKFK20240505 Agregu√© canal, subcanal y tipologia ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[VW_CLIENTES_NUEVOS] AS
SELECT C.FECHA, C.RUTA, C.CODIGO,  C.NOMBRE, C.DIRECCION, 
C.NIT AS RUC, 
CASE WHEN C.IMAGEN IS NULL THEN 'NO' ELSE 'SI' END AS TIENE_IMAGEN,
S.EMPRESA, E.NOMBRE AS NOM_EMPRESA,
S.CODIGO AS CODIGO_SUCURSAL, S.NOMBRE AS NOM_SUCURSAL, C.CODIGO_ERP, C.STATCOM, 'D_CLINUEVO' AS TIPO,
'N/D' CANAL, 'N/D' SUBCANAL, 'ND' TIPOLOGIA
FROM D_CLINUEVO C INNER JOIN P_RUTA R ON C.RUTA = R.CODIGO
INNER JOIN P_SUCURSAL S ON R.SUCURSAL = S.CODIGO
INNER JOIN P_EMPRESA E ON S.EMPRESA = E.EMPRESA
UNION
SELECT C.FECHA, C.RUTA, C.CODIGO,  C.NOMBRE, C.DIRECCION, 
C.NIT AS RUC, 
CASE WHEN C.IMAGEN IS NULL THEN 'NO' ELSE 'SI' END AS TIENE_IMAGEN,
S.EMPRESA, E.NOMBRE AS NOM_EMPRESA,
S.CODIGO AS CODIGO_SUCURSAL, S.NOMBRE AS NOM_SUCURSAL, C.CODIGO_ERP, C.STATCOM, 'D_CLINUEVOT' AS TIPO,
ISNULL(N.CODIGO + ' ' + N.NOMBRE,'N/D') CANAL, 
ISNULL(B.CODIGO + ' ' + B.NOMBRE,'N/D') SUBCANAL,
ISNULL(T.CODIGO + ' ' + T.NOMBRE,'N/D') TIPOLOGIA
FROM D_CLINUEVOT C INNER JOIN P_RUTA R ON C.RUTA = R.CODIGO
INNER JOIN P_SUCURSAL S ON R.SUCURSAL = S.CODIGO
INNER JOIN P_EMPRESA E ON S.EMPRESA = E.EMPRESA
LEFT JOIN P_CANAL N ON N.CODIGO = C.CANAL
LEFT JOIN P_CANALSUB B ON B.CODIGO = C.SUBCANAL
LEFT JOIN P_TIPOLOGIA T ON T.CODIGO = C.TIPOLOGIA
GO

ALTER VIEW [dbo].[VW_CLIENTES_NUEVOS] AS
SELECT C.FECHA, C.RUTA, C.CODIGO,  C.NOMBRE, C.DIRECCION, 
C.NIT AS RUC, 
CASE WHEN (C.IMAGEN IS NULL OR DATALENGTH(C.Imagen) = 0) THEN 'NO' ELSE 'SI' END AS TIENE_IMAGEN,
S.EMPRESA, E.NOMBRE AS NOM_EMPRESA,
S.CODIGO AS CODIGO_SUCURSAL, S.NOMBRE AS NOM_SUCURSAL, C.CODIGO_ERP, C.STATCOM, 'D_CLINUEVO' AS TIPO
FROM D_CLINUEVO C INNER JOIN P_RUTA R ON C.RUTA = R.CODIGO
INNER JOIN P_SUCURSAL S ON R.SUCURSAL = S.CODIGO
INNER JOIN P_EMPRESA E ON S.EMPRESA = E.EMPRESA
UNION
SELECT C.FECHA, C.RUTA, C.CODIGO,  C.NOMBRE, C.DIRECCION, 
C.NIT AS RUC, 
CASE WHEN (C.IMAGEN IS NULL OR DATALENGTH(C.Imagen) = 0) AND (I.IMGDOCUMENTO IS NULL OR DATALENGTH(I.IMGDOCUMENTO) = 0 ) THEN 'NO' ELSE 'SI' END AS TIENE_IMAGEN,
S.EMPRESA, E.NOMBRE AS NOM_EMPRESA,
S.CODIGO AS CODIGO_SUCURSAL, S.NOMBRE AS NOM_SUCURSAL, C.CODIGO_ERP, C.STATCOM, 'D_CLINUEVOT'
FROM D_CLINUEVOT C LEFT OUTER JOIN D_CLINUEVOT_IMAGEN I ON I.CODIGO = C.CODIGO AND I.RUTA= C.RUTA
INNER JOIN P_RUTA R ON C.RUTA = R.CODIGO
INNER JOIN P_SUCURSAL S ON R.SUCURSAL = S.CODIGO
INNER JOIN P_EMPRESA E ON S.EMPRESA = E.EMPRESA
GO

/****** Object:  View [dbo].[VW_CLIENTES_NUEVOS]    Script Date: 28/09/2021 10:26:30 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE VIEW [dbo].[VW_CLIENTES_NUEVOS] AS
SELECT C.FECHA, C.RUTA, C.CODIGO,  C.NOMBRE, C.DIRECCION, 
C.NIT AS RUC, 
CASE WHEN C.IMAGEN IS NULL THEN 'NO' ELSE 'SI' END AS TIENE_IMAGEN,
S.EMPRESA, E.NOMBRE AS NOM_EMPRESA,
S.CODIGO AS CODIGO_SUCURSAL, S.NOMBRE AS NOM_SUCURSAL, C.CODIGO_ERP, C.STATCOM, 'D_CLINUEVO' AS TIPO
FROM D_CLINUEVO C INNER JOIN P_RUTA R ON C.RUTA = R.CODIGO
INNER JOIN P_SUCURSAL S ON R.SUCURSAL = S.CODIGO
INNER JOIN P_EMPRESA E ON S.EMPRESA = E.EMPRESA
UNION
SELECT C.FECHA, C.RUTA, C.CODIGO,  C.NOMBRE, C.DIRECCION, 
C.NIT AS RUC, 
CASE WHEN C.IMAGEN IS NULL THEN 'NO' ELSE 'SI' END AS TIENE_IMAGEN,
S.EMPRESA, E.NOMBRE AS NOM_EMPRESA,
S.CODIGO AS CODIGO_SUCURSAL, S.NOMBRE AS NOM_SUCURSAL, C.CODIGO_ERP, C.STATCOM, 'D_CLINUEVOT'
FROM D_CLINUEVOT C INNER JOIN P_RUTA R ON C.RUTA = R.CODIGO
INNER JOIN P_SUCURSAL S ON R.SUCURSAL = S.CODIGO
INNER JOIN P_EMPRESA E ON S.EMPRESA = E.EMPRESA
GO
