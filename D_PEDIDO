--#CKFK20240606
ALTER TABLE D_PEDIDO ADD TIPO_PEDIDO nvarchar(10) null

--#CKFK20240504
ALTER TABLE D_PEDIDO 
ADD ANULADO_POR_MONTO_MINIMO BIT NOT NULL DEFAULT 0,
    CUMPLE_MONTO_MINIMO BIT NOT NULL DEFAULT 0

ALTER TABLE D_PEDIDO ADD FECHA_SISTEMA DATETIME NOT NULL DEFAULT GETDATE()

UPDATE  D_PEDIDO SET FECHA = CONVERT(DATE, FECHA), FECHAENTR = CONVERT(DATE, FECHAENTR)

CREATE NONCLUSTERED INDEX NCLI_DPEDIDO_EMPRESA_20210623_EJCA
ON [dbo].[D_PEDIDO] ([EMPRESA])
INCLUDE ([COREL],[ANULADO],[FECHA],[RUTA],[VENDEDOR],[CLIENTE],[FECHAENTR],[STATCOM])

/****** Object:  Trigger [dbo].[trgUpdateFlagF]    Script Date: 27/08/2021 15:45:29 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER TRIGGER [dbo].[trgUpdateFlagPed]
   ON  [dbo].[D_PEDIDO]
   AFTER INSERT
AS 
BEGIN
	
	SET NOCOUNT ON;

    -- Insert statements for trigger here
    DECLARE @COREL NVARCHAR(20)
    
    SELECT @COREL = COREL FROM INSERTED
    
    UPDATE D_PEDIDO SET D_PEDIDO.STATCOM = 'T' WHERE D_PEDIDO.COREL = @COREL AND NOT EXISTS (SELECT CODIGO FROM P_CLIENTE WHERE D_PEDIDO.CLIENTE = P_CLIENTE.CODIGO)
END
GO

