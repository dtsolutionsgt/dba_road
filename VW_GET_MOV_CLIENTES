/****** Object:  View [dbo].[VW_GET_MOV_CLIENTES]    Script Date: 02/08/2022 11:28:48 p.Â m. ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE VIEW [dbo].[VW_GET_MOV_CLIENTES]
AS
SELECT T.CLIENTE, T.FECHA, T.PRODUCTO, T.SUCURSAL, 
      SUM(T.CANT_RECO) AS CANT_RECO,
      SUM(T.CANT_ENTR) AS CANT_ENTR, 
      SUM(T.PESO_RECO) AS PESO_RECO, 
      SUM(T.PESO_ENTR) AS PESO_ENTR, 
      SUM(T.CANT_AJUSTE_NEG) AS CANT_AJUSTE_NEG,
      SUM(T.CANT_AJUSTE_POS) AS CANT_AJUSTE_POS,
      SUM(T.PESO_AJUSTE_NEG) AS PESO_AJUSTE_NEG,
      SUM(T.PESO_AJUSTE_POS) AS PESO_AJUSTE_POS
FROM 
(SELECT D_CANASTA.CLIENTE + ' - ' + P_CLIENTE.NOMBRE AS Cliente, 
	    D_CANASTA.FECHA, 
		D_CANASTA.PRODUCTO, 
	    SUM(D_CANASTA.CANTREC) AS CANT_RECO, 
	    SUM(D_CANASTA.CANTENTR) AS CANT_ENTR, 
	    SUM(D_CANASTA.PESOREC) AS PESO_RECO, 
	    SUM(D_CANASTA.PESOENTR) AS PESO_ENTR, 
		0 AS CANT_AJUSTE_NEG,
		0 AS CANT_AJUSTE_POS,
		0 AS PESO_AJUSTE_NEG,
		0 AS PESO_AJUSTE_POS,
		P_CLIENTE.SUCURSAL
FROM  P_RUTA INNER JOIN
D_CANASTA ON P_RUTA.CODIGO = D_CANASTA.RUTA INNER JOIN
P_CLIENTE ON D_CANASTA.CLIENTE = P_CLIENTE.CODIGO INNER JOIN
P_VENDEDOR ON D_CANASTA.VENDEDOR = P_VENDEDOR.CODIGO
GROUP BY D_CANASTA.RUTA + '- ' + P_RUTA.NOMBRE, 
	                   D_CANASTA.CLIENTE + ' - ' + P_CLIENTE.NOMBRE, 
	                   D_CANASTA.VENDEDOR + ' - ' + P_VENDEDOR.NOMBRE, 
	                   D_CANASTA.FECHA, D_CANASTA.PRODUCTO, P_CLIENTE.SUCURSAL
UNION
SELECT  P_CLIENTE.CODIGO + ' - ' + P_CLIENTE.NOMBRE AS CLIENTE,
	    P_CANASTA_MOV.FECHA_MOV AS FECHA, 
		P_CANASTA_MOV.PRODUCTO, 
	    0 AS CANT_RECO, 
	    0 AS CANT_ENTR, 
	    0 AS PESO_RECO, 
	    0 AS PESO_ENTR, 
		P_CANASTA_MOV.CANTIDAD_AJUSTE_NEGATIVO AS CANT_AJUSTE_NEG,
		P_CANASTA_MOV.CANTIDAD_AJUSTE_POSITIVO AS CANT_AJUSTE_POS,
		P_CANASTA_MOV.PESO_AJUSTE_NEGATIVO AS PESO_AJUSTE_NEG,
		P_CANASTA_MOV.PESO_AJUSTE_POSITIVO AS PESO_AJUSTE_POS,
		P_CLIENTE.SUCURSAL
FROM  dbo.P_CANASTA_MOV INNER JOIN
      dbo.P_CLIENTE ON dbo.P_CLIENTE.CODIGO = dbo.P_CANASTA_MOV.CLIENTE) T
GROUP BY T.CLIENTE, T.FECHA, T.PRODUCTO, T.SUCURSAL
GO

